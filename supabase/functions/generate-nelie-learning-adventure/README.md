# Supabase Edge Function: `generate-nelie-learning-adventure`

This Edge Function is designed to dynamically generate comprehensive, narrative-driven "Learning Adventure" objects based on a given theme and target audience. It leverages a Large Language Model (LLM) like OpenAI's GPT to construct the adventure's storyline, chapters, embedded learning activities, and associated metadata.

## Purpose

To automate the creation of rich, multi-step learning experiences that are engaging for K-12 students and align with NELIE's educational philosophy. This function provides the structured data needed by the frontend to render a complete Learning Adventure.

## Input: `AdventureGenerationRequest`

The function expects a JSON payload in the request body matching the `AdventureGenerationRequest` interface (defined notionally within `index.ts`, but should mirror `src/types/learningAdventureTypes.ts`). Key fields include:

-   `targetAudience`: (object) Specifies `gradeLevelMin` and `gradeLevelMax`.
-   `themePrompt`: (string) A descriptive prompt for the adventure's theme (e.g., "A journey to build a sustainable city," "Solving a historical mystery").
-   `desiredDurationType`: (string) Enum type like 'singleDay', 'multiDay', 'weekLong'.
-   `studentInterests`: (array of strings, optional) Helps tailor the narrative and activities.
-   `mandatorySubjectsOrSkills`: (array of strings, optional) Ensures specific educational content is integrated.

## Output: `LearningAdventure`

The function returns a single, complex JSON object that conforms to the `LearningAdventure` interface (also notionally defined in `index.ts` and mirroring `src/types/learningAdventureTypes.ts`). This object includes:

-   Overall adventure details (ID, title, theme, logline, introduction, conclusion, image prompts).
-   `targetAudience` and `targetDurationType`.
-   `learningObjectivesSummary` and `mainCharacters`.
-   An optional `initialChoicePoint` with multiple `ChoiceOption`s, each leading to a different `StoryArc`.
-   A `storyArcs` object containing one or more `StoryArc` definitions.
-   Each `StoryArc` contains multiple `Chapter`s.
-   Each `Chapter` includes narrative text, an image prompt, and an array of `EmbeddedActivityRequest` objects. These requests specify the `activityType`, `subject`, `skillArea`, etc., for activities to be generated by the `generate-nelie-activity-content` function.
-   `subjectsCovered`, `skillsDeveloped`, and `tags` for the adventure.

## Core Logic

1.  **Request Handling:** Receives the `AdventureGenerationRequest`. Handles CORS preflight requests.
2.  **Prompt Engineering:** The `craftLLMLearningAdventurePrompt` function dynamically constructs a highly detailed prompt for the LLM. This prompt instructs the LLM to:
    *   Adopt the NELIE persona.
    *   Adhere to specific tone, style, and visual description guidelines.
    *   Integrate specified subjects and interests.
    *   Generate content for all fields within the `LearningAdventure` JSON structure.
    *   Crucially, it demands the LLM's entire response be a single, valid JSON object conforming to the `LearningAdventure` structure.
3.  **LLM Interaction (Placeholder):** The `index.ts` file contains commented-out placeholder code for making an API call to an LLM service (e.g., OpenAI). This section must be uncommented and configured with appropriate API keys and endpoint details for live AI generation.
4.  **Mock Response (Current Implementation):** For development and testing without live LLM calls, the function currently uses `generateMockLearningAdventure`. This function generates a pre-defined, complex `LearningAdventure` object that includes branching story arcs and embedded activity requests, tailored slightly by the input `AdventureGenerationRequest`.
5.  **Response Formatting:** Returns the generated (or mocked) `LearningAdventure` object as a JSON response.
6.  **Error Handling:** Includes basic error handling for request issues or internal errors, returning a JSON error object with a 500 status code.

## Environment Variables

For live LLM integration (e.g., with OpenAI), you will need to set the following environment variable in your Supabase project settings (under Settings > Functions):

-   `OPENAI_API_KEY`: Your API key for the OpenAI service.

(Add any other LLM provider-specific keys or configuration URLs as needed).

## Deployment

Deploy this function to your Supabase project using the Supabase CLI:

```bash
supabase functions deploy generate-nelie-learning-adventure --no-verify-jwt
```

Consider JWT verification (`--verify-jwt` enabled by default if not specified) for production environments unless you have other authentication mechanisms in place.

## Example Invocation (Conceptual)

Using `curl`:

```bash
curl -X POST 'YOUR_SUPABASE_FUNCTION_URL/generate-nelie-learning-adventure' \
-H 'Authorization: Bearer YOUR_SUPABASE_ANON_KEY' \
-H 'Content-Type: application/json' \
-d '{
      "targetAudience": { "gradeLevelMin": 3, "gradeLevelMax": 5 },
      "themePrompt": "A magical quest to find the lost colors of the rainbow",
      "desiredDurationType": "multiDay",
      "studentInterests": ["fantasy", "art", "puzzles"],
      "mandatorySubjectsOrSkills": ["Color Theory", "Problem Solving"]
    }'
```

Replace `YOUR_SUPABASE_FUNCTION_URL` and `YOUR_SUPABASE_ANON_KEY` with your actual Supabase project details.
The types (`ActivityType`, `LearningAdventure`, etc.) are inlined in the `index.ts` for self-containment in the Deno environment, but they are intended to mirror the definitions in `src/types/learningAdventureTypes.ts` and relevant parts of `src/components/education/components/types/LessonTypes.ts`. Ensure consistency if these shared types evolve.
